<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSI Ratings | Digital Maturity Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --tsi-primary: #006A67; /* Primary Dark Teal Color */
            --background: #f4fbf9; /* Light, clean background */
            --border-color: #d1d5db; /* Light gray for borders */
        }

        body {
            background-color: var(--background);
            font-family: ui-sans-serif, system-ui, sans-serif;
        }

        .primary-bg { background-color: var(--tsi-primary); }
        .primary-text { color: var(--tsi-primary); }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
        }

        .radio-option:checked {
            background-color: var(--tsi-primary);
            border-color: var(--tsi-primary);
        }

        .radio-label:has(.radio-option:checked) {
            background-color: #e0f2f1; /* Light teal background */
            border-color: var(--tsi-primary);
            color: var(--tsi-primary);
            font-weight: 600;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tsi-primary': 'var(--tsi-primary)',
                    }
                }
            }
        }

        const AUTH_TOKEN = localStorage.getItem('token');
        // --- API Endpoint Definition ---
        const DMA_API_URL = '/api/v1/dma';

        // Global state
        let dmaQuestionnaire = null;
        const assessmentResults = {};
        let totalQuestionsCount = 0; // Will be set after fetching

        // --- Utility Functions ---

        /**
         * Shows a message to the user in the result area.
         * @param {string} message - The message text.
         * @param {string} type - 'success', 'error', 'info', or 'default'.
         */
        function showResultMessage(message, type = 'default') {
            const resultElement = document.getElementById('result-message');
            resultElement.classList.remove('hidden', 'bg-red-100', 'text-red-600', 'bg-green-100', 'text-green-600');
            resultElement.classList.add('transition-opacity', 'duration-300');

            if (type === 'error') {
                resultElement.classList.add('bg-red-100', 'text-red-600');
            } else if (type === 'success') {
                resultElement.classList.add('bg-green-100', 'text-green-600');
            }

            resultElement.textContent = message;
        }

        // --- API Integration ---

        /**
         * Fetches the DMA questionnaire template from the backend.
         */
        async function fetchQuestionnaire() {
            showResultMessage('Loading questionnaire...', 'info');

            try {
                // Assuming a POST request with _func to get the template
                const response = await fetch(DMA_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        _func: 'get_dma_questionnaire',
                        version: 'v1.0'
                    })
                });

                const data = await response.json();

                if (response.ok && data) {
                    dmaQuestionnaire = data;
                    renderAssessmentForm(dmaQuestionnaire);
                    showResultMessage(dmaQuestionnaire.questionnaireTitle + ' loaded successfully.', 'info');
                } else {
                    const errorMsg = data.error_details || data.error_message || 'Failed to retrieve questionnaire template.';
                    showResultMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showResultMessage('Network error. Could not connect to DMA service.', 'error');
            }
        }

        /**
         * Simulates the submission of the final score and data to the blockchain anchor system.
         */
        async function submitAssessment() {
            const finalScore = calculateScore(true); // Calculate score and stop if questions are missing

            if (!finalScore) return; // Stop if not all questions are answered

            // Disable buttons during submission
            const submitButton = document.querySelector('button[onclick="submitAssessment()"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            showResultMessage('Submitting assessment and preparing for blockchain anchoring...', 'info');

            // --- API CALL: submitAssessment ---
            try {
                // Note: The payload must match the DMA_Assessment table structure (assessmentDetailJson)
                const submissionPayload = {
                    _func: 'submitAssessment', // Assumed function name
                    msmeId: 101, // Placeholder: Must be retrieved from session/context
                    auditorId: 201, // Placeholder: Must be retrieved from session/context
                    finalTsiScore: finalScore.percentageScore,
                    assessmentDetailJson: {
                        version: finalScore.version,
                        results: finalScore.answers
                    }
                };

                const response = await fetch(DMA_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionPayload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResultMessage(`Assessment submitted successfully! Score: ${finalScore.percentageScore}%. Anchor ID: ${data.anchorId}.`, 'success');

                    // Update button state to Submitted (read-only)
                    submitButton.textContent = 'Assessment Submitted';
                    submitButton.classList.remove('primary-bg');
                    submitButton.classList.add('bg-gray-500');
                    document.querySelector('button[onclick="calculateScore()"]').disabled = true;
                } else {
                    const errorMsg = data.error_details || data.error_message || 'Submission failed. Please try again.';
                    showResultMessage(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showResultMessage('Network error. Could not connect to submit the assessment.', 'error');
            } finally {
                if(submitButton.textContent === 'Submitting...') {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit & Anchor to Blockchain';
                }
            }
        }

        // --- Core Functions ---

        /**
         * Calculates the total TSI Score based on the selected answers.
         * @param {boolean} stopIfIncomplete - If true, displays an error and returns null if not all questions are answered.
         */
        function calculateScore(stopIfIncomplete = false) {
            if (!dmaQuestionnaire) {
                showResultMessage('Error: Questionnaire data is not loaded.', 'error');
                return null;
            }

            let totalScore = 0;
            let maxScore = 0;
            let answeredQuestions = 0;

            dmaQuestionnaire.sections.forEach(section => {
                section.questions.forEach(question => {
                    maxScore += 5; // Max score for each question is 5

                    const selectedValue = assessmentResults[question.questionId];
                    if (selectedValue !== undefined) {
                        totalScore += selectedValue;
                        answeredQuestions++;
                    }
                });
            });

            // Check if all questions are answered
            if (answeredQuestions !== totalQuestionsCount) {
                if (stopIfIncomplete) {
                    showResultMessage(`Please answer all ${totalQuestionsCount} questions (${answeredQuestions} answered) before submission.`, 'error');
                    return null;
                }
                showResultMessage(`Incomplete: ${answeredQuestions}/${totalQuestionsCount} questions answered.`, 'info');
                return null;
            }

            // Calculate percentage score (0-100)
            const percentageScore = (totalScore / maxScore) * 100;

            showResultMessage(`Final DMA Score: ${percentageScore.toFixed(2)}% (Total Points: ${totalScore} / ${maxScore})`, 'success');

            return {
                version: dmaQuestionnaire.version,
                totalScore: totalScore,
                maxScore: maxScore,
                percentageScore: percentageScore.toFixed(2),
                answers: assessmentResults
            };
        }

        /**
         * Renders the entire assessment form based on the fetched dmaData JSON.
         * @param {object} data - The fetched questionnaire object.
         */
        function renderAssessmentForm(data) {
            const formContainer = document.getElementById('assessment-form-container');
            if (!formContainer) return;
            formContainer.innerHTML = ''; // Clear loading message

            totalQuestionsCount = 0;

            data.sections.forEach((section, sectionIndex) => {
                // 1. Create Section Container
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-10 p-6 card';

                // 2. Create Section Title
                const sectionTitle = document.createElement('h2');
                sectionTitle.className = 'text-xl font-bold primary-text mb-6 pb-2 border-b border-gray-200';
                sectionTitle.textContent = `${section.sectionId}. ${section.sectionTitle}`;
                sectionDiv.appendChild(sectionTitle);

                // 3. Render Questions
                section.questions.forEach((question, questionIndex) => {
                    totalQuestionsCount++;

                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mb-6 p-4 border rounded-lg bg-gray-50';

                    // Question Text
                    const questionText = document.createElement('p');
                    questionText.className = 'text-base font-semibold text-gray-800 mb-3';
                    questionText.textContent = `${question.questionId}. ${question.questionText}`;
                    questionDiv.appendChild(questionText);

                    // Options Container
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'flex flex-wrap gap-3';

                    question.options.forEach(option => {
                        const label = document.createElement('label');
                        label.className = 'radio-label flex-1 flex items-center p-3 text-sm text-gray-700 bg-white border border-gray-300 rounded-md cursor-pointer transition-colors duration-150 ease-in-out hover:border-tsi-primary min-w-[200px] sm:min-w-0';
                        label.setAttribute('for', `${question.questionId}-${option.value}`);

                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = question.questionId;
                        input.id = `${question.questionId}-${option.value}`;
                        input.value = option.value;
                        input.className = 'radio-option h-4 w-4 text-tsi-primary border-gray-300 mr-2 focus:ring-tsi-primary';

                        // Event listener to track the score immediately
                        input.addEventListener('change', (e) => {
                            assessmentResults[question.questionId] = parseInt(e.target.value);
                            document.getElementById('result-message').classList.add('hidden'); // Hide message on new answer
                        });

                        label.appendChild(input);
                        label.appendChild(document.createTextNode(option.text));
                        optionsDiv.appendChild(label);
                    });

                    questionDiv.appendChild(optionsDiv);
                    sectionDiv.appendChild(questionDiv);
                });

                formContainer.appendChild(sectionDiv);
            });
        }

        // Run the rendering function when the window loads
        window.onload = fetchQuestionnaire;
    </script>
</head>
<body class="p-8">

<div class="max-w-4xl mx-auto">
    <header class="text-center mb-8">
        <div class="flex items-center justify-center mb-4">
            <h1 class="text-4xl font-extrabold primary-text">TSI Ratings</h1>
        </div>
        <p class="text-xl font-semibold text-gray-700 mb-1" id="questionnaire-title">Digital Maturity Assessment (DMA)</p>
        <p class="text-sm text-gray-500">MSME: **Shakti Textiles & Exports** | Assessor: Alex Johnson</p>
    </header>

    <main>
        <form id="dma-form" onsubmit="event.preventDefault();">
            <div id="assessment-form-container">
                <div class="text-center p-12 card text-gray-500 font-semibold" id="loading-message">
                    Loading Digital Maturity Questionnaire... Please wait.
                </div>
            </div>

            <div class="sticky bottom-0 p-4 mt-6 card flex justify-between items-center z-10">
                <div id="result-message" class="text-lg font-bold hidden px-4 py-2 rounded-lg bg-red-100 text-red-600 transition-opacity duration-300">
                </div>

                <div class="flex space-x-4 ml-auto">
                    <button type="button" onclick="calculateScore()"
                            class="px-6 py-3 border border-tsi-primary text-tsi-primary rounded-lg font-semibold hover:bg-tsi-primary hover:text-white transition duration-200">
                        Calculate Final Score
                    </button>
                    <button type="button" onclick="submitAssessment()"
                            class="px-6 py-3 primary-bg text-white rounded-lg font-semibold hover:bg-opacity-90 transition duration-200">
                        Submit & Anchor to Blockchain
                    </button>
                </div>
            </div>
        </form>
    </main>
</div>

</body>
</html>